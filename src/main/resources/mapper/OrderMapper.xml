<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.xiaozhang.devicemanagesystem.server.mapper.OrderMapper">

    <insert id="inInsertOrder" keyProperty="id" useGeneratedKeys="true">
        insert into insert_order
         (code,device_name,device_model,count,price,manufacturer,dept_id,create_time,admin_id)
        values
            (#{code} ,#{deviceName} ,#{deviceModel} ,#{count} ,#{price} ,#{manufacturer} ,#{deptId} ,#{createTime} ,#{adminId} )
    </insert>

    <update id="updateInsertOrder" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.InsertOrder">
        update insert_order
            <set>
                <if test="code != null and code != ''">
                    code = #{code},
                </if>
                <if test="deviceName != null and deviceName != ''">
                    device_name = #{deviceName},
                </if>
                <if test="deviceModel != null and deviceModel != ''">
                    device_model = #{deviceModel},
                </if>
                <if test="count != null and count != ''">
                    count = #{count},
                </if>
                <if test="price != null and price != ''">
                    price = #{price},
                </if>
                <if test="manufacturer != null and manufacturer != ''">
                    manufacturer = #{manufacturer},
                </if>
                <if test="deptId != null and deptId != ''">
                    dept_id = #{deptId},
                </if>
                <if test="createTime != null and createTime != ''">
                    create_time = #{createTime},
                </if>
                <if test="adminId != null and adminId != ''">
                    admin_id = #{adminId},
                </if>
            </set>
        where id = #{id}
    </update>

    <insert id="inScrapOrder" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.ScrapOrder">
        insert into scrap_order
            (code,device_id,reason,admin_id,create_time)
            values
                (#{code},#{deviceId},#{reason},#{adminId},#{createTime})
    </insert>

    <insert id="inBorrowOrder" keyProperty="id" useGeneratedKeys="true">
        insert into borrow_order
            (code,description,create_time,user_id,status,admin_id,handle_time)
            values
                (#{code},#{description},#{createTime},#{userId},#{status},#{adminId},#{handleTime})
    </insert>

    <insert id="inBorrowDetail" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.BorrowDetail">
        insert into borrow_detail
        (borrow_id,device_id,borrow_time,user_id,return_status,return_time)
        values
            (#{borrowId},#{deviceId},#{borrowTime},#{userId},#{returnStatus},#{returnTime})
    </insert>

    <select id="getBorrowOrder" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.BorrowOrderVO">
        select *
        from v_user_borrow
        <where>
            <if test="userId != null and userId != ''">
                and user_id = #{userId}
            </if>
            <if test="status != null and status != ''">
                and status = #{status}
            </if>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{beginTime}
            </if>
        </where>
        order by status,create_time
    </select>

    <select id="getDevicesByBorrowId" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.DeviceVO">
        select v_device.* from v_device,borrow_detail
        where borrow_detail.borrow_id = #{borrowOrderId} and borrow_detail.device_id = v_device.id
    </select>

    <select id="getUserBorrowDevices" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.BorrowDetailVO">
        select * from v_borrow
        <where>
            <if test="userId != null and userId != ''">
                and user_id = #{userId}
            </if>
            <if test="returnStatus != null and returnStatus != ''">
                and return_status = #{returnStatus}
            </if>
        </where>
        order by borrow_time desc
    </select>

    <select id="getBorrowDetail" resultType="com.xiaozhang.devicemanagesystem.pojo.entity.BorrowDetail">
        select * from borrow_detail
        <where>
            <if test="id != null and id != ''">
                and id = #{id}
            </if>
            <if test="borrowId != null and borrowId != ''">
                and borrow_id = #{borrowId}
            </if>
            <if test="deviceId != null and deviceId != ''">
                and device_id = #{deviceId}
            </if>
            <if test="userId != null and userId != ''">
                and user_id = #{userId}
            </if>
            <if test="returnStatus != null and returnStatus != ''">
                and return_status = #{returnStatus}
            </if>
        </where>
    </select>


    <update id="updateBorrowDetail" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.BorrowDetail">
        update borrow_detail
            <set>
                <if test="borrowId != null and borrowId != ''">
                     borrow_id = #{borrowId},
                </if>
                <if test="deviceId != null and deviceId != ''">
                     device_id = #{deviceId},
                </if>
                <if test="userId != null and userId != ''">
                     user_id = #{userId},
                </if>
                <if test="returnStatus != null and returnStatus != ''">
                     return_status = #{returnStatus},
                </if>
                <if test="borrowTime != null">
                    borrow_time = #{borrowTime},
                </if>
                <if test="returnTime != null">
                    return_time = #{returnTime},
                </if>
            </set>
        where borrow_id = #{borrowId} and device_id = #{deviceId}
    </update>

    <select id="getFeedbacks" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.FeedBackVO">
        select * from v_feedback
        <where>
            <if test="userId != null and userId != ''">
                and user_id = #{userId}
            </if>
            <if test="status != null and status != ''">
                and status = #{status}
            </if>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
        order by status ,create_time
    </select>

    <insert id="inFeedbackOrder" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.FeedbackOrder">
        insert into feedback_order
        (code,device_id,device_problem,user_id,status,admin_id,create_time,handle_time)
            values
                (#{code},#{deviceId},#{deviceProblem},#{userId},#{status},#{adminId},#{createTime},#{handleTime})

    </insert>


    <update id="updateBorrowOrder" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.BorrowOrder">
        update borrow_order
            <set>
                <if test="code != null and code != ''">
                    code = #{code},
                </if>
                <if test="createTime != null ">
                    create_time = #{createTime},
                </if>
                <if test="description != null and description != ''">
                    description = #{description},
                </if>
                <if test="userId != null and userId != ''">
                    user_id = #{userId},
                </if>
                <if test="status != null and status != ''">
                    status = #{status},
                </if>
                <if test="adminId != null and adminId != ''">
                    admin_id = #{adminId},
                </if>
                <if test="handleTime != null ">
                    handle_time = #{handleTime},
                </if>
            </set>
        where id = #{id}
    </update>

    <update id="updateFeedbackOrder" parameterType="com.xiaozhang.devicemanagesystem.pojo.entity.FeedbackOrder">
        update feedback_order
            <set>
                <if test="code != null and code != ''">
                    code = #{code},
                </if>
                <if test="deviceId != null and deviceId != ''">
                    device_id = #{deviceId},
                </if>
                <if test="deviceProblem != null and deviceProblem != ''">
                    device_problem = #{deviceProblem},
                </if>
                <if test="userId != null and userId != ''">
                    user_id = #{userId},
                </if>
                <if test="status != null and status != ''">
                    status = #{status},
                </if>
                <if test="adminId != null and adminId != ''">
                    admin_id = #{adminId},
                </if>
                <if test="createTime != null">
                    create_time = #{createTime},
                </if>
                <if test="handleTime != null">
                    handle_time = #{handleTime}
                </if>
            </set>
        where id = #{id}
    </update>


    <select id="getInsertOrders" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.InsertOrderVO">
        select * from v_insert
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>

    <select id="getScrapOrders" resultType="com.xiaozhang.devicemanagesystem.pojo.vo.ScrapOrderVO">
        select * from v_scrap
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>

    <select id="getInsertCountByMap" resultType="Integer">
        select count(*) from insert_order
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>


    <select id="getBorrowCountByMap" resultType="Integer">
        select count(*) from borrow_order
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>

    <select id="getFeedbackCountByMap" resultType="Integer">
        select count(*) from feedback_order
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>

    <select id="getScrapCountByMap" resultType="Integer">
        select count(*) from scrap_order
        <where>
            <if test="beginTime != null">
                and create_time &gt; #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
    </select>
</mapper>